<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Assessment Admin Console — Subjects & Grades (Per‑Grade in Schools CSV)</title>
  <style>
    :root{ --bg:#0b1020; --card:#121830; --card-2:#0f1530; --text:#e5e7eb; --muted:#9aa4b2; --primary:#4f46e5; --primary-2:#6366f1; --accent:#22c55e; --border:#26304d; --danger:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#12152b);color:var(--text);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto}
    a{color:var(--primary-2)}
    .container{max-width:1080px;margin:24px auto 64px;padding:0 16px}
    .header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin:12px 0 24px}
    .brand{display:flex;align-items:center;gap:12px}
    .dot{width:12px;height:12px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--accent));box-shadow:0 0 0 4px #1b2140 inset}
    h1{font-size:20px;margin:0}
    .card{background:radial-gradient(1200px 600px at 0 -200px,rgba(79,70,229,.2),transparent 40%),var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;box-shadow:0 6px 24px rgba(0,0,0,.22);margin-bottom:16px}
    .grid{display:grid;gap:14px}
    @media(min-width:860px){.grid-2{grid-template-columns:1fr 1fr}.grid-3{grid-template-columns:repeat(3,1fr)}}
    label{display:block;font-size:12.5px;color:var(--muted);margin-bottom:6px}
    input[type=text],input[type=number],textarea,select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#0d1330;color:var(--text);outline:none}
    input:focus,textarea:focus,select:focus{border-color:var(--primary-2);box-shadow:0 0 0 3px rgba(99,102,241,.18)}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:11px 14px;border-radius:12px;border:1px solid var(--border);background:linear-gradient(180deg,var(--primary-2),var(--primary));color:#fff;font-weight:600;cursor:pointer;box-shadow:0 10px 24px rgba(79,70,229,.25)}
    .btn.secondary{background:transparent;color:var(--text)}
    .btn.small{padding:8px 10px;border-radius:10px}
    .muted{color:var(--muted);font-size:12.5px}
    .pill{padding:6px 10px;border-radius:999px;background:#0e1636;border:1px solid var(--border);color:var(--muted);font-size:12px}
    .row{display:flex;align-items:center;gap:8px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid rgba(255,255,255,.08);padding:8px 6px;text-align:left}
    .kbd{font-family:ui-monospace,Menlo,monospace;background:#0e1532;border:1px solid var(--border);padding:2px 6px;border-radius:6px}
    .error{color:var(--danger);font-size:12.5px}
    .success{color:var(--accent)}
    .drop{border:1px dashed var(--border);border-radius:12px;padding:14px;text-align:center;background:#0e1532}
    .right{justify-content:flex-end}
    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#0e1532;cursor:pointer;user-select:none}
    .chip input{width:16px;height:16px}
    input,textarea,select{font-size:16px}
    .btn{min-height:44px}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="brand"><div class="dot"></div><h1>Assessment Admin Console — Subjects & Grades (Per‑Grade in Schools CSV)</h1></div>
      <span class="pill">Google Sheets Adapter</span>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px">Configuration</h3>
      <div class="grid grid-2">
        <div>
          <label>Apps Script Web App URL (ends with /exec)</label>
          <input id="cfg_script" type="text" placeholder="https://script.google.com/macros/s/DEPLOYMENT_ID/exec">
          <div class="muted">Same Sheet you created (Runs/Schools/Evaluators/Submissions).</div>
        </div>
        <div>
          <label>Admin Key</label>
          <input id="cfg_key" type="text" placeholder="Set the same ADMIN_KEY in Apps Script">
          <div class="muted">Guards admin endpoints. Keep it secret.</div>
        </div>
      </div>
      <div class="grid grid-2" style="margin-top:8px">
        <div>
          <label>Collector HTML URL</label>
          <input id="cfg_collector" type="text" placeholder="https://your-host/collector.html">
          <div class="muted">Used to generate shareable links.</div>
        </div>
        <div class="row right" style="align-items:flex-end">
          <button class="btn small" id="cfg_save">Save</button>
        </div>
      </div>
      <div id="cfg_status" class="muted" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px">Create Run</h3>
      <div class="grid grid-3">
        <div>
          <label>Project</label>
          <input id="run_project" type="text" placeholder="Baseline 2025">
        </div>
        <div>
          <label>Year (YYYY)</label>
          <input id="run_year" type="number" placeholder="2025">
        </div>
        <div>
          <label>Round</label>
          <input id="run_round" type="text" placeholder="Round 1">
        </div>
      </div>
      <div class="grid" style="margin-top:8px">
        <div>
          <label>Grades for this run</label>
          <div class="row" style="gap:8px; flex-wrap:wrap; margin-bottom:6px">
            <button type="button" class="btn small secondary" id="grades_select_all">Select all</button>
            <button type="button" class="btn small secondary" id="grades_clear">Clear</button>
          </div>
          <div id="gradesWrap" class="chips" role="group" aria-label="Grades"></div>
          <div class="muted">Pick Grade 1–12. The collector will show only these grades.</div>
        </div>
        <div>
          <label>Subjects for this run</label>
          <div class="row" style="gap:8px; flex-wrap:wrap; margin-bottom:6px">
            <button type="button" class="btn small secondary" id="subjects_select_all">Select all</button>
            <button type="button" class="btn small secondary" id="subjects_clear">Clear</button>
          </div>
          <div id="subjectsWrap" class="chips" role="group" aria-label="Subjects"></div>
          <div class="muted">Choose which subjects will be collected.</div>
        </div>
      </div>
      <div class="row right" style="margin-top:8px">
        <button class="btn" id="btn_create_run">Create Run</button>
      </div>
      <div id="create_status" class="muted" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px">Upload Schools CSV (with per‑grade totals)</h3>
      <div class="grid grid-2">
        <div>
          <label>Run ID</label>
          <input id="schools_run" type="text" placeholder="Paste the Run ID here">
        </div>
        <div class="row right" style="align-items:flex-end">
          <a class="btn secondary small" id="dl_sch_template" href="#">Download CSV template</a>
        </div>
      </div>
      <div class="drop" id="drop_sch">Drop CSV here or click to choose<input id="file_sch" type="file" accept=".csv" style="display:none"></div>
      <div class="muted" style="margin-top:8px">Template columns: school totals + <b>Enrolled/Required Grade 1..12</b>.</div>
      <div id="sch_status" class="muted" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px">Upload Evaluators CSV (optional)</h3>
      <div class="grid grid-2">
        <div>
          <label>Run ID</label>
          <input id="eval_run" type="text" placeholder="Paste the Run ID here">
        </div>
        <div class="row right" style="align-items:flex-end">
          <a class="btn secondary small" id="dl_eval_template" href="#">Download CSV template</a>
        </div>
      </div>
      <div class="drop" id="drop_eval">Drop CSV here or click to choose<input id="file_eval" type="file" accept=".csv" style="display:none"></div>
      <div id="eval_status" class="muted" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">Runs</h3>
        <button class="btn small" id="btn_refresh_runs">Refresh</button>
      </div>
      <div class="muted" style="margin:6px 0 10px">Copy the collector link for a run. Add &ev=CODE for evaluator-specific.</div>
      <div style="overflow:auto">
        <table class="table" id="runs_table">
          <thead>
            <tr>
              <th>Run ID</th>
              <th>Project</th>
              <th>Year</th>
              <th>Round</th>
              <th>Grades</th>
              <th>Subjects</th>
              <th>Link</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="runs_status" class="muted" style="margin-top:8px"></div>
    </div>

    <div id="toast" class="pill" style="position:fixed;right:16px;bottom:16px;display:none;z-index:100;background:#071031">Done</div>
  </div>

<script>
(() => {
  const SUBJECTS = ['Maths','Language','English','Physics','Chemistry','Biology','Social Science','Science','History','Geography','EVS','Accountancy','Economics'];
  const GRADES = Array.from({length:12}, (_,i)=>`Grade ${i+1}`);

  const cfg = { script: localStorage.getItem('cfg_script') || '', key: localStorage.getItem('cfg_key') || '', collector: localStorage.getItem('cfg_collector') || '' };
  const $ = s => document.querySelector(s);
  function toast(msg){ const t=$('#toast'); t.textContent=msg; t.style.display='inline-flex'; setTimeout(()=>t.style.display='none',1800); }
  function setStatus(el, msg, kind='info'){ el.innerHTML = msg ? (kind==='error'?`<span class="error">${msg}</span>`: msg) : ''; }

  function renderChips(containerId, values){ const wrap = document.getElementById(containerId); wrap.innerHTML=''; values.forEach(val=>{ const id=`${containerId}_`+val.replace(/\W+/g,'_'); const lbl=document.createElement('label'); lbl.className='chip'; lbl.htmlFor=id; lbl.innerHTML=`<input type="checkbox" id="${id}" value="${val}" /> <span>${val}</span>`; wrap.appendChild(lbl); }); }
  renderChips('subjectsWrap', SUBJECTS); renderChips('gradesWrap', GRADES);
  function setAll(containerId, checked){ document.querySelectorAll(`#${containerId} input[type=checkbox]`).forEach(cb=>cb.checked=checked); }
  $('#grades_select_all').onclick = ()=> setAll('gradesWrap', true);
  $('#grades_clear').onclick = ()=> setAll('gradesWrap', false);
  $('#subjects_select_all').onclick = ()=> setAll('subjectsWrap', true);
  $('#subjects_clear').onclick = ()=> setAll('subjectsWrap', false);

  $('#cfg_script').value = cfg.script; $('#cfg_key').value = cfg.key; $('#cfg_collector').value = cfg.collector;
  $('#cfg_save').onclick = () => { cfg.script=$('#cfg_script').value.trim(); cfg.key=$('#cfg_key').value.trim(); cfg.collector=$('#cfg_collector').value.trim(); localStorage.setItem('cfg_script', cfg.script); localStorage.setItem('cfg_key', cfg.key); localStorage.setItem('cfg_collector', cfg.collector); setStatus($('#cfg_status'), '<span class="success">Saved ✓</span>'); toast('Saved'); };

  $('#btn_create_run').onclick = async () => {
    const project=$('#run_project').value.trim(); const year=Number($('#run_year').value.trim()); const round=$('#run_round').value.trim();
    const grades=Array.from(document.querySelectorAll('#gradesWrap input:checked')).map(cb=>cb.value).join('|');
    const subjects=Array.from(document.querySelectorAll('#subjectsWrap input:checked')).map(cb=>cb.value).join('|');
    if (!cfg.script || !cfg.key) { setStatus($('#create_status'),'Set Script URL and Admin Key in Configuration','error'); return; }
    if (!project || !year || !round || !grades || !subjects){ setStatus($('#create_status'),'Fill all fields and pick grades + at least one subject','error'); return; }
    setStatus($('#create_status'),'Creating…');
    try{
      const res = await fetch(cfg.script+"?action=adminCreate",{ method:'POST', headers:{ 'Content-Type':'text/plain' }, body: JSON.stringify({ adminKey: cfg.key, project, year, round, grades, subjects }) });
      const json = await res.json(); if (!json.ok) throw new Error(json.error||'Failed');
      const runId=json.runId; setStatus($('#create_status'), `<span class="success">Run created</span> · Run ID: <span class="kbd">${runId}</span>`);
      $('#schools_run').value=runId; $('#eval_run').value=runId; await refreshRuns();
    } catch(err){ setStatus($('#create_status'), String(err),'error'); }
  };

  function makeDownload(id, filename, headers){ const csv=headers.join(',')+"\n"; const blob=new Blob([csv],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.getElementById(id); a.href=url; a.download=filename; }
  makeDownload('dl_sch_template','schools_template.csv',[
    'UDISE','School name','State','District','Block','Number of students enrolled','Number of students required',
    ...Array.from({length:12},(_,i)=>[`Enrolled Grade ${i+1}`,`Required Grade ${i+1}`]).flat()
  ]);
  makeDownload('dl_eval_template','evaluators_template.csv',['Evaluator code','Evaluator name']);

  function wireDrop(areaId, inputId, onFile){ const area=document.getElementById(areaId); const file=document.getElementById(inputId); area.addEventListener('click',()=> file.click()); area.addEventListener('dragover', e=>{e.preventDefault(); area.style.background='#101a3d';}); area.addEventListener('dragleave', ()=>{area.style.background='#0e1532';}); area.addEventListener('drop', e=>{e.preventDefault(); area.style.background='#0e1532'; if (e.dataTransfer.files[0]) onFile(e.dataTransfer.files[0]);}); file.addEventListener('change', ()=>{ if (file.files[0]) onFile(file.files[0]); }); }

  const SCHOOL_REQUIRED = ['UDISE','School name','State','District','Block','Number of students enrolled','Number of students required', ...Array.from({length:12},(_,i)=>[`Enrolled Grade ${i+1}`,`Required Grade ${i+1}`]).flat()];
  const EVAL_REQUIRED = ['Evaluator code','Evaluator name'];

  wireDrop('drop_sch','file_sch', async (f)=>{
    const runId=$('#schools_run').value.trim(); if (!runId) { setStatus($('#sch_status'),'Enter Run ID','error'); return; }
    if (!cfg.script || !cfg.key) { setStatus($('#sch_status'),'Set Script URL and Admin Key in Configuration','error'); return; }
    setStatus($('#sch_status'),'Reading CSV…');
    const text=await f.text(); const {headers, rows}=parseCSV(text);
    const missing=SCHOOL_REQUIRED.filter(h=>!headers.includes(h)); if (missing.length){ setStatus($('#sch_status'),'Missing required columns: '+missing.join(', '),'error'); return; }
    setStatus($('#sch_status'),'Uploading…');
    try{
      const res = await fetch(cfg.script+"?action=adminUpload",{ method:'POST', headers:{ 'Content-Type':'text/plain' }, body: JSON.stringify({ adminKey: cfg.key, runId, kind:'schools', rows }) });
      const json=await res.json(); if (!json.ok) throw new Error(json.error||'Failed');
      setStatus($('#sch_status'), `<span class="success">Uploaded</span> · ${json.inserted||json.upserted||0} rows`); await refreshRuns();
    }catch(err){ setStatus($('#sch_status'), String(err),'error'); }
  });

  wireDrop('drop_eval','file_eval', async (f)=>{
    const runId=$('#eval_run').value.trim(); if (!runId) { setStatus($('#eval_status'),'Enter Run ID','error'); return; }
    if (!cfg.script || !cfg.key) { setStatus($('#eval_status'),'Set Script URL and Admin Key in Configuration','error'); return; }
    setStatus($('#eval_status'),'Reading CSV…');
    const text=await f.text(); const {headers, rows}=parseCSV(text);
    const missing=EVAL_REQUIRED.filter(h=>!headers.includes(h));
    if (missing.length){ setStatus($('#eval_status'),'Missing required columns: '+missing.join(', '),'error'); return; }
    setStatus($('#eval_status'),'Uploading…');
    try{
      const res = await fetch(cfg.script+"?action=adminUpload",{ method:'POST', headers:{ 'Content-Type':'text/plain' }, body: JSON.stringify({ adminKey: cfg.key, runId, kind:'evaluators', rows }) });
      const json=await res.json(); if (!json.ok) throw new Error(json.error||'Failed');
      setStatus($('#eval_status'), `<span class="success">Uploaded</span> · ${json.inserted||json.upserted||0} rows`);
    }catch(err){ setStatus($('#eval_status'), String(err),'error'); }
  });

  function parseCSV(text){
    const rows=[]; let cur=''; let row=[]; let inQuotes=false;
    for (let i=0;i<text.length;i++){
      const c=text[i]; const n=text[i+1];
      if (inQuotes){
        if (c==='"' && n==='"'){ cur+='"'; i++; }
        else if (c==='"'){ inQuotes=false; }
        else { cur+=c; }
      } else {
        if (c==='"'){ inQuotes=true; }
        else if (c===','){ row.push(cur); cur=''; }
        else if (c==='\n'){ row.push(cur); rows.push(row); row=[]; cur=''; }
        else if (c==='\r'){ }
        else { cur+=c; }
      }
    }
    if (cur.length>0 || row.length>0) { row.push(cur); rows.push(row); }
    if (rows.length && rows[0].length){ rows[0][0] = rows[0][0].replace(/^\ufeff/, ''); }
    const headers=(rows.shift()||[]).map(h=>String(h).trim());
    const out=rows.filter(r=>r.some(v=>String(v).trim()!==''))
      .map(r=>Object.fromEntries(headers.map((h,i)=>[h, r[i] === undefined ? '' : r[i]])));
    return { headers, rows: out };
  }

  async function refreshRuns(){
    if (!cfg.script){ setStatus($('#runs_status'),'Set Script URL in Configuration','error'); return; }
    setStatus($('#runs_status'),'Loading…');
    try{
      const res=await fetch(cfg.script+'?action=listruns');
      const json=await res.json();
      if (!json.ok || !Array.isArray(json.runs)) throw new Error(json.error||'Failed');
      const tbody=$('#runs_table tbody'); tbody.innerHTML='';
      json.runs.forEach(r=>{
        const runId=String(r.runId||''); const grades=String(r.gradesConfigured||''); const subjects=String(r.subjectsConfigured||'');
        const tr=document.createElement('tr');
        const link=cfg.collector ? `${cfg.collector}?runId=${encodeURIComponent(runId)}` : '(set Collector URL)';
        tr.innerHTML=`<td><span class="kbd">${runId}</span></td><td>${r.project||''}</td><td>${r.year||''}</td><td>${r.round||''}</td><td>${grades}</td><td>${subjects}</td><td><div class="row"><button class="btn small secondary" data-link="${link}">Copy link</button><span class="muted">&nbsp;Add <span class="kbd">&ev=EV-0001</span> for evaluator-specific</span></div></td>`;
        tbody.appendChild(tr);
      });
      tbody.querySelectorAll('button[data-link]').forEach(btn=>{ btn.addEventListener('click',()=>{ navigator.clipboard.writeText(btn.getAttribute('data-link')); toast('Copied'); }); });
      setStatus($('#runs_status'), `Loaded ${json.runs.length} run(s)`);
    } catch(err){ setStatus($('#runs_status'), String(err),'error'); }
  }
  document.getElementById('btn_refresh_runs').onclick = refreshRuns;
  if (cfg.script) refreshRuns();
})();
</script>
</body>
</html>
